import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

path = "/home/onyxia/work/statapp_sujet26/"
file_name1 = "dataset_complet_part_1.csv"
file_name2 = "dataset_complet_part_2.csv"
df1 = pd.read_csv(path + file_name1, sep=',', low_memory=False)
df2 = pd.read_csv(path + file_name2, sep=',', low_memory=False)
df = pd.concat([df1, df2])
df['grav'] = df['grav'].replace({'1': 0, '2': 0, '3': 1, '4': 1, 1: 0, 2: 0, 3: 1, 4: 1}).astype(int)
df = df[df['an'] == 2019]

print((df.isna().mean() * 100).round(2))

df = df[['Num_Acc', 'an', 'surf', 'grav']]

def map_surface_category(surf_state):
    """
    Mapping pour regrouper les états de surface en catégories personnalisées.
    """
    if surf_state in [2, 3, 4]:
        return 'Route avec eau'
    elif surf_state in [5, 7]:
        return 'Route gelée'
    elif surf_state == 1:
        return 'Route normale'
    elif surf_state in [6, 8]:
        return 'Route boueuse/huileuse'
    else:
        return 'Autre'

# Apply the mapping to the data
df['surf'] = df['surf'].apply(map_surface_category)

# Filter to exclude unwanted categories
df_filtered = df[df['surf'] != 'Autre']

# Define the desired order of surface categories
desired_order = ['Route normale', 'Route boueuse/huileuse', 'Route avec eau', 'Route gelée']

# Create a pivot table to prepare data for the graph
pivot_table = df_filtered.pivot_table(index='surf', columns='grav', aggfunc='size', fill_value=0)

# Plot the bar chart
plt.figure(figsize=(10, 6))
ax = pivot_table.plot(kind='bar', stacked=False)

# Customize labels and title
plt.xlabel('État de la surface')
plt.ylabel("Nombre d'accidents")
plt.title("Répartition des conditions de surface lors des accidents routiers en 2019")

# Add legend
plt.legend(title='Gravité')

# Adjust x-axis labels
labels = [label[:15] for label in pivot_table.index]
plt.xticks(range(len(labels)), labels, rotation=0, fontsize=8)

# Save the figure
plt.savefig(path + 'stat_des2/statap_surf_corrige.png', bbox_inches='tight')
plt.show()
